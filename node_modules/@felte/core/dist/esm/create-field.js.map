{"version":3,"file":"create-field.js","sources":["../../src/create-field.ts"],"sourcesContent":["import type { FieldValue, FormControl } from '@felte/common';\nimport { isFormControl, setControlValue, isElement } from '@felte/common';\n\nexport type FieldConfig = {\n  name: string;\n  touchOnChange?: boolean;\n  defaultValue?: FieldValue;\n  onFormReset?(e: ResetEvent): void;\n};\n\nexport type Field = {\n  field(node: HTMLElement): { destroy?(): void };\n  onInput(value: FieldValue): void;\n  onChange(value: FieldValue): void;\n  onBlur(): void;\n};\n\ntype EventType = 'input' | 'change' | 'focusout';\n\ntype ResetEvent = Event & { target: HTMLFormElement };\n\nconst observerConfig = {\n  attributes: true,\n  attributeFilter: ['data-felte-validation-message', 'aria-invalid'],\n};\n\nexport function createField(\n  name: string,\n  config?: Omit<FieldConfig, 'name'>\n): Field;\nexport function createField(config: FieldConfig): Field;\nexport function createField(\n  nameOrConfig: FieldConfig | string,\n  config?: Omit<FieldConfig, 'name'>\n): Field;\nexport function createField(\n  nameOrConfig: FieldConfig | string,\n  config?: Omit<FieldConfig, 'name'>\n): Field {\n  let name: string;\n  let defaultValue: FieldValue;\n  let touchOnChange: boolean;\n  let fieldNode: HTMLElement;\n  let control: FormControl;\n  let onFormReset: ((e: ResetEvent) => void) | undefined;\n\n  if (typeof nameOrConfig === 'string') {\n    name = nameOrConfig;\n    defaultValue = config?.defaultValue;\n    touchOnChange = config?.touchOnChange ?? false;\n    onFormReset = config?.onFormReset;\n  } else {\n    name = nameOrConfig.name;\n    defaultValue = nameOrConfig.defaultValue;\n    touchOnChange = nameOrConfig.touchOnChange ?? false;\n    onFormReset = nameOrConfig?.onFormReset;\n  }\n\n  function dispatchEvent(eventType: 'focusout'): void;\n  function dispatchEvent(\n    eventType: 'input' | 'change',\n    value: FieldValue\n  ): void;\n  function dispatchEvent(eventType: EventType, value?: FieldValue): void {\n    if (!control) return;\n    setControlValue(control, value);\n    const customEvent = new Event(eventType, {\n      bubbles: true,\n      composed: true,\n    });\n    control.dispatchEvent(customEvent);\n  }\n\n  function mutationCallback(mutationList: MutationRecord[]) {\n    mutationList.forEach(() => {\n      const invalid = control.getAttribute('aria-invalid');\n      if (!invalid) fieldNode.removeAttribute('aria-invalid');\n      else fieldNode.setAttribute('aria-invalid', invalid);\n      const validationMessage = control.getAttribute(\n        'data-felte-validation-message'\n      );\n      if (!validationMessage)\n        fieldNode.removeAttribute('data-felte-validation-message');\n      else\n        fieldNode.setAttribute(\n          'data-felte-validation-message',\n          validationMessage\n        );\n    });\n  }\n\n  function handleReset(e: Event) {\n    if (!onFormReset) return;\n    setControlValue(control, defaultValue);\n    onFormReset(e as ResetEvent);\n  }\n\n  function field(node: HTMLElement) {\n    fieldNode = node;\n    let observer: MutationObserver;\n    let formElement: HTMLFormElement | null;\n    if (isFormControl(node)) {\n      control = node;\n      control.name = name;\n      return {};\n    } else {\n      // This setTimeout is necessary to guarantee the node has been mounted\n      let created = false;\n      let destroyed = false;\n      setTimeout(() => {\n        if (destroyed) return;\n        const parent = fieldNode.parentNode;\n        if (!parent || !isElement(parent)) return;\n        const foundControl = parent.querySelector(`[name=\"${name}\"]`);\n        if (!foundControl || !isFormControl(foundControl)) {\n          const input = document.createElement('input');\n          input.type = 'hidden';\n          input.name = name;\n          parent.insertBefore(input, node.nextSibling);\n          control = input;\n          created = true;\n        } else {\n          control = foundControl;\n        }\n        setControlValue(control, defaultValue);\n\n        observer = new MutationObserver(mutationCallback);\n        observer.observe(control, observerConfig);\n        formElement = control.closest('form');\n        formElement?.addEventListener('reset', handleReset);\n      });\n      return {\n        destroy() {\n          if (created) control.parentNode?.removeChild(control);\n          destroyed = true;\n          observer?.disconnect();\n          formElement?.removeEventListener('reset', handleReset);\n        },\n      };\n    }\n  }\n\n  function onInput(value: FieldValue) {\n    dispatchEvent(touchOnChange ? 'change' : 'input', value);\n  }\n\n  function onBlur() {\n    dispatchEvent('focusout');\n  }\n  return {\n    field,\n    onInput,\n    onChange: onInput,\n    onBlur,\n  };\n}\n"],"names":[],"mappings":"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"}